name: Build and Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  security-events: write

jobs:
  # ============================================
  # Backend Build & Test
  # ============================================
  backend-build:
    name: Backend - Build & Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres123
          POSTGRES_DB: ai_platform
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx

      - name: Run Database Migrations
        run: |
          cd backend
          python - <<EOF
          import asyncio
          from app.database import engine, Base
          async def init_db():
              async with engine.begin() as conn:
                  await conn.run_sync(Base.metadata.create_all)
              await engine.dispose()
          asyncio.run(init_db())
          EOF
        env:
          DATABASE_URL: postgresql://postgres:postgres123@localhost:5432/ai_platform
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test-secret-key
          GOOGLE_API_KEY: test-key

      - name: Run Tests
        run: |
          cd backend
          pytest test/ -v --cov=app --cov-report=xml --cov-report=html
        env:
          DATABASE_URL: postgresql://postgres:postgres123@localhost:5432/ai_platform
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test-secret-key
          GOOGLE_API_KEY: test-key

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/htmlcov/

      - name: Build Docker Image
        run: |
          docker build -t syn-backend:${{ github.sha }} backend/

      - name: Test Docker Image
        run: |
          docker run --rm syn-backend:${{ github.sha }} python -c "from app.main import app; print('✅ Docker image works!')"

  # ============================================
  # Frontend Build & Test
  # ============================================
  frontend-build:
    name: Frontend - Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd frontend
          rm -rf node_modules package-lock.json
          npm install --include=optional

      - name: Lint
        run: |
          cd frontend
          npm run lint

      - name: Build
        run: |
          cd frontend
          CI=true NODE_OPTIONS=--max-old-space-size=4096 NEXT_TELEMETRY_DISABLED=1 NEXT_OTEL_FETCH_DISABLED=1 npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/.next/

  # ============================================
  # Docker Compose Integration Test
  # ============================================
  integration-test:
    name: Integration Test (Docker Compose)
    runs-on: ubuntu-latest
    needs: [backend-build, frontend-build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          DB_USER=postgres
          DB_PASSWORD=postgres123
          DB_NAME=ai_platform
          REDIS_HOST=redis
          REDIS_PORT=6379
          REDIS_PASSWORD=redis123
          JWT_SECRET=test-jwt-secret-key-for-ci
          JWT_ALGORITHM=HS256
          JWT_EXPIRATION_HOURS=24
          GOOGLE_API_KEY=test-google-api-key
          API_KEY_SECRET=test-api-key-secret
          ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000
          EOF

      - name: Start services with Docker Compose
        run: |
          docker compose up -d
          sleep 30

      - name: Check services health
        run: |
          docker compose ps

          # Check PostgreSQL
          docker compose exec -T postgres pg_isready -U postgres

          # Check Redis
          docker compose exec -T redis redis-cli -a redis123 ping

          # Check Backend API
          curl -f http://localhost:8080/health || exit 1

          echo "✅ All services are healthy!"

      - name: Run API Integration Tests
        run: |
          # Test health endpoint
          curl -f http://localhost:8080/health

          # Test API docs
          curl -f http://localhost:8080/docs

          echo "✅ Integration tests passed!"

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose logs

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
